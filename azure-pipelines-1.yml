trigger:
  branches:
    include:
      - main

pool:
  name: 'managed-pool-agents'

variables:
- group: defender-cli-secrets   # ðŸ”¹ brings in DEFENDER_* as secrets

- name: imageName
  value: 'intentionally-vulnerable-demo-image'
- name: imageTag
  value: '$(Build.BuildId)'
- name: fullImage
  value: '$(imageName):$(imageTag)'

- name: dockerfilePath
  value: 'Dockerfile'
- name: dockerfileFolder
  value: '.'

steps:
- checkout: self

- script: |
    echo "==== Installing Tools ===="
    sudo apt-get update -y
    sudo apt-get install -y docker.io rpm wget curl jq

    echo "==== Enabling & Starting Docker Daemon ===="
    sudo systemctl enable docker || true
    sudo systemctl start docker || true
    sudo systemctl status docker --no-pager || true

    echo "==== Docker version ===="
    docker --version || sudo docker --version
  displayName: 'Install Docker, RPM, and Start Docker Daemon'

- script: |
    echo "==== Downloading Defender for Cloud CLI ===="
    curl -L -o defender "https://aka.ms/defender-cli_linux-x64"
    chmod +x defender
    ./defender --version
  displayName: 'Install Defender CLI'

- script: |
    echo "==== Building Docker Image ===="
    echo "Current directory: $(pwd)"
    ls -la

    sudo docker build -f $(dockerfilePath) -t $(fullImage) $(dockerfileFolder)

    echo "Image built: $(fullImage)"
    echo "Docker images:"
    sudo docker images
  displayName: 'Build Docker Image'

# âœ… MDVM Scan â€“ token-based, secrets come from variable group
- script: |
    echo "==== Running Defender for Cloud MDVM Scan ===="

    # Check env vars (note: correct Bash syntax now)
    if [ -z "$DEFENDER_TENANT_ID" ] || [ -z "$DEFENDER_CLIENT_ID" ] || [ -z "$DEFENDER_CLIENT_SECRET" ]; then
      echo "One or more DEFENDER_* variables are missing."
      exit 1
    fi

    echo "Starting image scan with Defender CLI..."
    sudo -E ./defender scan image "$(fullImage)" \
      --defender-output "$(Build.SourcesDirectory)/defender-results.sarif"
    EXIT_CODE=$?

    echo "Defender CLI exit code: $EXIT_CODE"

    if [ "$EXIT_CODE" -ne 0 ]; then
      echo "MDVM scan failed with exit code $EXIT_CODE"
      exit $EXIT_CODE
    fi

    echo "MDVM scan completed successfully."
  displayName: 'Scan Docker Image with Defender CLI (MDVM)'
  env:
    DEFENDER_TENANT_ID: $(DEFENDER_TENANT_ID)
    DEFENDER_CLIENT_ID: $(DEFENDER_CLIENT_ID)
    DEFENDER_CLIENT_SECRET: $(DEFENDER_CLIENT_SECRET)
