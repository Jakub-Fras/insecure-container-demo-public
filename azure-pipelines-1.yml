trigger:
  branches:
    include:
      - main

pool:
  name: 'managed-pool-agents'

variables:
  imageName: 'intentionally-vulnerable-demo-image'
  imageTag: '$(Build.BuildId)'
  fullImage: '$(imageName):$(imageTag)'

  dockerfilePath: 'Dockerfile'
  dockerfileFolder: '.'

steps:
- checkout: self

# Install dependencies
- script: |
    echo "==== Installing Tools ===="
    sudo apt-get update -y
    sudo apt-get install -y docker.io rpm wget curl jq

    echo "==== Enabling & Starting Docker Daemon ===="
    sudo systemctl enable docker || true
    sudo systemctl start docker || true
    sudo systemctl status docker --no-pager || true

    echo "==== Docker version ===="
    docker --version || sudo docker --version
  displayName: 'Install Docker, RPM, and Start Docker Daemon'

# Download Defender CLI
- script: |
    echo "==== Downloading Defender for Cloud CLI ===="
    curl -L -o defender "https://aka.ms/defender-cli_linux-x64"
    chmod +x defender
    ./defender --version
  displayName: 'Install Defender CLI'

# Build Docker image
- script: |
    echo "==== Building Docker Image ===="
    echo "Current directory: $(pwd)"
    ls -la

    sudo docker build -f $(dockerfilePath) -t $(fullImage) $(dockerfileFolder)

    echo "Image built: $(fullImage)"
    echo "Docker images:"
    sudo docker images
  displayName: 'Build Docker Image'

# MDVM Scan â€“ Connector-based authentication
- script: |
    echo "==== Running Defender for Cloud MDVM Scan (ADO Connector Auth) ===="

    echo "Checking System.AccessToken..."
    if [ -z "$SYSTEM_ACCESSTOKEN" ]; then
      echo "ERROR: SYSTEM_ACCESSTOKEN is empty. Connector auth cannot work."
      exit 1
    fi
    echo "SYSTEM_ACCESSTOKEN is present."

    echo "Starting image scan with Defender CLI using connector authentication..."
    sudo -E ./defender scan image "$(fullImage)"

    EXIT_CODE=$?
    echo "Defender CLI exit code: $EXIT_CODE"

    if [ "$EXIT_CODE" -ne 0 ]; then
      echo "MDVM scan failed with exit code $EXIT_CODE"
      exit $EXIT_CODE
    fi

    echo "MDVM scan completed successfully."
  displayName: 'Scan Docker Image with Defender CLI (MDVM - Connector Auth)'
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
