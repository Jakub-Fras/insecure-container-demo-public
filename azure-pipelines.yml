trigger:
  branches:
    include:
      - main

pool:
  name: 'managed-pool-agents'

variables:
  imageName: 'insecure-demo-app'
  imageTag: '$(Build.BuildId)'
  fullImage: '$(imageName):$(imageTag)'

steps:
  - checkout: self

  # Robust SBOM FROM SOURCE + SCA SCAN (uses official install scripts; avoids apt repo issues)
  - script: |
      set -euo pipefail
      echo ">>> Install Syft (SBOM generator)"
      curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
      /usr/local/bin/syft --version || true

      echo ">>> Generate SBOM from source (SPDX JSON)"
      /usr/local/bin/syft dir:. -o spdx-json=sbom-source.spdx.json

      echo ">>> Install Trivy (standalone binary)"
      curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
      /usr/local/bin/trivy --version || true

      echo ">>> Scan SBOM for vulnerabilities (fail on HIGH/CRITICAL)"
      /usr/local/bin/trivy sbom --input sbom-source.spdx.json --exit-code 1 --severity HIGH,CRITICAL
    displayName: 'Generate + Scan SBOM (source)'

  # Install Docker + wget on the managed agent
  - script: |
      sudo apt-get update -y
      sudo apt-get install -y docker.io wget apt-transport-https gnupg lsb-release
      docker --version
    displayName: 'Install Docker and tools'

  # Build the container image
  - script: |
      sudo docker build -t $(fullImage) .
    displayName: 'Build image'

  # OPTIONAL: generate SBOM from built image (if desired)
  - script: |
      set -euo pipefail
      if command -v /usr/local/bin/syft >/dev/null 2>&1; then
        echo ">>> Generating SBOM from built image"
        /usr/local/bin/syft $(fullImage) -o spdx-json=sbom-image.spdx.json || true

        echo ">>> Scanning SBOM (image) for vulnerabilities"
        /usr/local/bin/trivy sbom --input sbom-image.spdx.json --exit-code 1 --severity HIGH,CRITICAL || true
      else
        echo ">>> syft not found; skipping image SBOM step"
      fi
    displayName: 'Generate + Scan SBOM (image)'
    condition: succeeded()

  # Install Trivy via binary install (ensure present) and scan the image
  - script: |
      set -euo pipefail
      /usr/local/bin/trivy --version || true

      sudo /usr/local/bin/trivy image \
        --severity HIGH,CRITICAL \
        --vuln-type os,library \
        --ignore-unfixed \
        --exit-code 1 \
        $(fullImage)
    displayName: 'Scan image'

  # Only runs if scan passed
  - script: |
      sudo docker run --rm -d --name test-container -p 8080:80 $(fullImage)
      sleep 5
      sudo docker stop test-container
    displayName: 'image is deployed only if Trvy has found no vulnrabilities'
    condition: succeeded()
